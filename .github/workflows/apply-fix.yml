name: Apply Fix from Issue

on:
  issue_comment:
    types: [created]

jobs:
  apply-fix:
    if: github.event.comment.body == '/apply-fix' && contains(github.event.issue.labels.*.name, 'auto-fix')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract fix metadata
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            const match = body.match(/```json\n([\s\S]*?)\n```/);
            if (!match) {
              core.setFailed('Could not find fix metadata in issue body');
              return;
            }
            const fix = JSON.parse(match[1]);
            core.setOutput('file', fix.file);
            core.setOutput('search', fix.search);
            core.setOutput('replace', fix.replace);
            core.setOutput('branch', fix.branch);
            core.setOutput('description', fix.description || 'Fix CI failure');
            console.log('Fix metadata:', fix);

      - name: Apply fix and create PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const file = '${{ steps.extract.outputs.file }}';
            const search = `${{ steps.extract.outputs.search }}`;
            const replace = `${{ steps.extract.outputs.replace }}`;
            const branch = '${{ steps.extract.outputs.branch }}';
            const description = '${{ steps.extract.outputs.description }}';

            // Read file
            let content = fs.readFileSync(file, 'utf-8');

            // Apply fix
            if (!content.includes(search)) {
              core.setFailed(`Could not find search string in ${file}`);
              return;
            }
            content = content.replace(search, replace);

            // Create branch
            const fixBranch = `fix/issue-${context.payload.issue.number}`;
            const { data: ref } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${branch}`
            });

            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${fixBranch}`,
                sha: ref.object.sha
              });
            } catch (e) {
              if (e.status !== 422) throw e; // Branch already exists, continue
            }

            // Get current file SHA
            const { data: fileData } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: file,
              ref: branch
            });

            // Commit fix
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: file,
              message: `ðŸ¤– ${description}\n\nFixes #${context.payload.issue.number}`,
              content: Buffer.from(content).toString('base64'),
              sha: fileData.sha,
              branch: fixBranch
            });

            // Create PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ¤– ${description}`,
              body: `Applies fix from #${context.payload.issue.number}\n\n---\n_Auto-generated by CI Failure Summarizer_`,
              head: fixBranch,
              base: branch
            });

            // Comment on issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `âœ… Fix PR created: ${pr.html_url}`
            });

            // Close issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              state: 'closed'
            });

            console.log(`Created PR: ${pr.html_url}`);
